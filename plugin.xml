<?xml version="1.0" encoding="UTF-8"?>
<plugin xmlns="http://apache.org/cordova/ns/plugins/1.0"
        xmlns:android="http://schemas.android.com/apk/res/android"
        id="cordova-plugin-os-manual-ota"
        version="1.0.0">

    <name>OutSystems Manual OTA</name>
    <description>Cordova plugin for manual control of OutSystems OTA updates with Background Fetch and Silent Push support</description>
    <license>MIT</license>
    <keywords>cordova,outsystems,ota,background-fetch,push</keywords>
    <repo>https://github.com/yourusername/cordova-plugin-os-manual-ota</repo>

    <js-module src="www/OSManualOTA.js" name="OSManualOTA">
        <clobbers target="OSManualOTA" />
    </js-module>

    <!-- Hooks -->
    <hook type="before_plugin_install" src="hooks/install_prerequisites.js" />
    <hook type="after_plugin_add" src="hooks/add_swift_support.js" />
    <hook type="after_prepare" src="hooks/after_prepare_setup_bridging_header.js" />
    <hook type="after_prepare" src="hooks/after_prepare_patch_ota.js" />
    <hook type="after_prepare" src="hooks/after_prepare_patch_splash.js" />

    <!-- iOS Platform -->
    <platform name="ios">
        <config-file target="config.xml" parent="/*">
            <feature name="OSManualOTA">
                <param name="ios-package" value="OSManualOTAPlugin"/>
            </feature>
        </config-file>

        <!-- Add Background Modes capability -->
        <config-file target="*-Info.plist" parent="UIBackgroundModes">
            <array>
                <string>fetch</string>
                <string>remote-notification</string>
            </array>
        </config-file>

        <!-- Minimum background fetch interval (iOS 7-12) -->
        <config-file target="*-Info.plist" parent="UIApplicationBackgroundFetchInterval">
            <real>3600</real> <!-- 1 hour, can be customized -->
        </config-file>

        <!-- BGTaskScheduler identifiers (iOS 13+) -->
        <config-file target="*-Info.plist" parent="BGTaskSchedulerPermittedIdentifiers">
            <array>
                <string>com.outsystems.manual-ota.refresh</string>
            </array>
        </config-file>

        <!-- Plugin source files -->
        <source-file src="src/ios/OSManualOTAPlugin.swift" />
        <source-file src="src/ios/OSManualOTAManager.swift" />
        <source-file src="src/ios/OSUpdateModels.swift" />

        <!-- Background Update Manager (Objective-C) - Handles Background Fetch -->
        <header-file src="src/ios/OSBackgroundUpdateManager.h" />
        <source-file src="src/ios/OSBackgroundUpdateManager.m" />

        <!-- Cache Helper (Objective-C) - Computes cache paths using OutSystems hash -->
        <header-file src="src/ios/OSCacheHelper.h" />
        <source-file src="src/ios/OSCacheHelper.m" />

        <!-- AppDelegate Swizzler (Objective-C) - Automatically hooks background operations -->
        <header-file src="src/ios/OSAppDelegateSwizzler.h" />
        <source-file src="src/ios/OSAppDelegateSwizzler.m" />

        <!-- OSNativeCache Category - Exposes internal methods for cache swapping -->
        <header-file src="src/ios/OSNativeCache+ManualOTA.h" />
        <source-file src="src/ios/OSNativeCache+ManualOTA.m" />

        <!-- Bridging header for OutSystems Objective-C classes -->
        <header-file src="src/ios/OSManualOTA-Bridging-Header.h" />

        <!-- Dependencies on OutSystems core plugin -->
        <dependency id="@outsystems/cordova-outsystems-core" />

        <!-- Framework dependencies -->
        <framework src="Foundation.framework" />
        <framework src="UIKit.framework" />
        <framework src="BackgroundTasks.framework" weak="true" />
    </platform>

</plugin>
